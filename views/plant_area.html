<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Plantation Areas</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body class="bg-light">
    <div class="container mt-5">
      <h2 class="text-center">Manage Plantation Areas</h2>
      <button
        class="btn btn-primary mb-3"
        data-bs-toggle="modal"
        data-bs-target="#addModal"
      >
        Add Plantation
      </button>
      <table class="table table-bordered bg-white">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Plantation Area</th>
            <th>Soil Type</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="plantationTable"></tbody>
      </table>
    </div>

    <!-- Add Plantation Modal -->
    <div class="modal fade" id="addModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Plantation</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <input
              type="text"
              id="plantationName"
              class="form-control mb-2"
              placeholder="Plantation Area"
            />
            <input
              type="text"
              id="soilType"
              class="form-control"
              placeholder="Soil Type"
            />
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary" id="savePlantation">
              Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Plantation Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Plantation</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editId" />
            <input
              type="text"
              id="editPlantationName"
              class="form-control mb-2"
            />
            <input type="text" id="editSoilType" class="form-control" />
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-success" id="updatePlantation">
              Update
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm Deletion</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete this plantation?</p>
            <input type="hidden" id="deleteId" />
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-danger" id="confirmDelete">
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      async function fetchPlantations() {
        const res = await fetch("/api/plantationarea");
        const data = await res.json();
        const tableBody = document.getElementById("plantationTable");
        tableBody.innerHTML = "";
        data.forEach((plantation) => {
          tableBody.innerHTML += `
                    <tr>
                        <td>${plantation.id}</td>
                        <td>${plantation.plantation_area}</td>
                        <td>${plantation.soil_type}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editPlantation(${plantation.id}, '${plantation.plantation_area}', '${plantation.soil_type}')" data-bs-toggle="modal" data-bs-target="#editModal">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="confirmDelete(${plantation.id})" data-bs-toggle="modal" data-bs-target="#deleteModal">Delete</button>
                        </td>
                    </tr>`;
        });
      }

      function validateInput(plantation_area, soil_type) {
        if (!plantation_area || !soil_type) {
          alert("All fields are required!");
          return false;
        }
        return true;
      }
      // Ensure editPlantation is globally accessible
      window.editPlantation = function (id, name, soil) {
        document.getElementById("editId").value = id;
        document.getElementById("editPlantationName").value = name;
        document.getElementById("editSoilType").value = soil;
      };

      function clearInputs() {
        document.getElementById("plantationName").value = "";
        document.getElementById("soilType").value = "";
        document.getElementById("editPlantationName").value = "";
        document.getElementById("editSoilType").value = "";
      }

      document
        .getElementById("savePlantation")
        .addEventListener("click", async () => {
          const plantation_area =
            document.getElementById("plantationName").value;
          const soil_type = document.getElementById("soilType").value;
          if (!validateInput(plantation_area, soil_type)) return;

          await fetch("/api/plantationarea", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ plantation_area, soil_type }),
          });
          clearInputs();
          fetchPlantations();
          $("#addModal").modal("hide");
        });

      document
        .getElementById("updatePlantation")
        .addEventListener("click", async () => {
          const id = document.getElementById("editId").value;
          const plantation_area =
            document.getElementById("editPlantationName").value;
          const soil_type = document.getElementById("editSoilType").value;
          if (!validateInput(plantation_area, soil_type)) return;

          await fetch(`/api/plantationarea/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ plantation_area, soil_type }),
          });
          clearInputs();
          fetchPlantations();
          $("#editModal").modal("hide");
        });

      function confirmDelete(id) {
        document.getElementById("deleteId").value = id;
      }

      document
        .getElementById("confirmDelete")
        .addEventListener("click", async () => {
          const id = document.getElementById("deleteId").value;
          await fetch(`/api/plantationarea/${id}`, { method: "DELETE" });
          fetchPlantations();
          $("#deleteModal").modal("hide");
        });

      fetchPlantations();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
